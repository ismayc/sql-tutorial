---
title: "SQL Query Exercise Answers on Pacific Northwest Flights out of SEA and PDX"
author: "Dr. Chester Ismay"
format: 
  html:
    toc: true
    toc-location: left
---

<!-- https://ismay-sql-tutorial.netlify.app/exercise-answers.html -->

This document contains SQL queries to explore the flights related tables from 2023 flights departing the SEA and PDX airports in our SQLite database. Note that query results are capped at 1000 records maximum to avoid the page being unable to load. There are more than 222,000 flights in the `flights` table covering all of 2023!

```{r setup}
#| include: false
library(DBI)
library(RSQLite)

suppressPackageStartupMessages(library(tidyverse))

# Copy data over into this folder
# file.copy(from = "../flights2023/pnwflights23/data/airlines.rda", 
#           to = "data/airlines.rda")
# file.copy(from = "../flights2023/pnwflights23/data/airports.rda",
#           to = "data/airports.rda")
# file.copy(from = "../flights2023/pnwflights23/data/flights.rda",
#           to = "data/flights.rda")
# file.copy(from = "../flights2023/pnwflights23/data/planes.rda",
#           to = "data/planes.rda")
# file.copy(from = "../flights2023/pnwflights23/data/weather.rda",
#           to = "data/weather.rda")

# Read data in from RDA files
load("exercises/data/airlines.rda")
load("exercises/data/airports.rda")
load("exercises/data/flights.rda")
load("exercises/data/planes.rda")
load("exercises/data/weather.rda")

## Create an RSQLite database
con <- dbConnect(RSQLite::SQLite(), dbname = "pnw_flights_database.sqlite")

# Write the new data to the database
dbWriteTable(con, "airlines", airlines, overwrite = TRUE)
dbWriteTable(con, "airports", airports, overwrite = TRUE)
dbWriteTable(con, "flights", flights, overwrite = TRUE)
dbWriteTable(con, "planes", planes, overwrite = TRUE)
dbWriteTable(con, "weather", weather, overwrite = TRUE)

# # Disconnect from the database
# dbDisconnect(con)

knitr::opts_chunk$set(#engine = "SQL", 
                      connection = con, warning=FALSE)
options(connection = con) 
```

```{r eval=FALSE, echo=FALSE, out.width='100%', fig.align='center'}
library(DiagrammeR)
# https://github.com/bergant/datamodelr
library(datamodelr)

dm_f <- dm_from_data_frames(airlines, airports, flights, planes, weather)

dm_f <- dm_add_references(
  dm_f,
  
  flights$carrier == airlines$carrier,
  flights$origin == airports$faa,
  flights$dest == airports$faa,
  flights$tailnum == planes$tailnum,
  weather$origin == airports$faa
)

graph <- dm_create_graph(dm_f, rankdir = "BT", col_attr = c("column", "type"))

dm_render_graph(graph)
```

<details open>
<summary style="display: inline-block; padding: 8px 16px; background-color: #337ab7; color: white; border-radius: 4px; cursor: pointer; font-weight: bold;">Click to show/hide ER Diagram</summary>
<br><br>
<img src="exercises/www/pnwflights_mermaid.png" width="60%" alt="Pacific Northwest Flights ER Diagram">
</details>


# Selection Techniques

## Selecting columns/fields

### 1. Select all airline names from the `airlines` table.

```{sql, output.var="sql_results"}
SELECT name
FROM airlines;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 2. Select all columns from the `weather` table.

```{sql, output.var="sql_results"}
SELECT *
FROM weather;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```


### 3. Select the FAA code and name from the `airports` table.

```{sql, output.var="sql_results"}
SELECT faa, name
FROM airports;
```


```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

## Aliasing

### 4. Select and alias specific columns from the airports table

```{sql, output.var="sql_results"}
SELECT faa AS code, name AS airport_name, alt AS altitude
FROM airports;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 5. Choose the destination airport code and air time from the flights table with an alias `f`

```{sql, output.var="sql_results"}
SELECT f.dest, f.air_time
FROM flights AS f;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

## Unique entries

### 6. Select all distinct time zones (`tz`) from the `airports` table.

```{sql, output.var="sql_results"}
SELECT DISTINCT tz
FROM airports;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

<!--
## View creation

### 7. Create a view named `flight_details` to select carrier and destination from the flights table

```{sql, echo=FALSE}
DROP VIEW IF EXISTS flight_details;
```

```{sql}
CREATE VIEW flight_details AS
SELECT carrier, dest
FROM flights;
```

No output given for `VIEW` creation.

### 8. Select all columns from the `flight_details` View

```{sql, output.var="sql_results"}
SELECT * 
FROM flight_details;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

-->

## Counting

### 7. Count the records in the flights table (aliased as `total_flights`)

```{sql, output.var="sql_results"}
SELECT COUNT(*) AS total_flights
FROM flights;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 8. Count all distinct carriers in the flights table as `total_distinct_carriers`

```{sql, output.var="sql_results"}
SELECT COUNT(DISTINCT carrier) AS total_distinct_carriers
FROM flights;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

# Filtering Techniques

## Filtering rows/records

### 9. Select Boeing Planes' Tail Numbers and Models

```{sql, output.var="sql_results"}
SELECT tailnum, model 
FROM planes 
WHERE manufacturer = 'BOEING';
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 10. Select airports above 40 latitude and in the America/New_York time zone.

```{sql, output.var="sql_results"}
SELECT faa, name, lat 
FROM airports 
WHERE lat > 40 
AND tzone = 'America/New_York';
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 11. Select airports (faa code and name) within 40 to 42 degrees latitude.

```{sql, output.var="sql_results"}
SELECT faa, name, lat 
FROM airports 
WHERE lat BETWEEN 40 AND 42;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

## Filtering text

### 12. Select airlines (carrier code and name) with name starting with an "A"

```{sql, output.var="sql_results"}
SELECT carrier, name 
FROM airlines 
WHERE name LIKE 'A%';
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 13. Select flights having 101 as the second, third, and fourth characters of the tail number.

```{sql, output.var="sql_results"}
SELECT tailnum 
FROM flights 
WHERE tailnum LIKE '_101%';
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 14. Select flights (all columns) where the carrier is either "AS" or "HA"

```{sql, output.var="sql_results"}
SELECT * 
FROM flights 
WHERE carrier IN ('AS', 'HA');
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 15. Select weather records (all columns) where wind direction is missing

```{sql, output.var="sql_results"}
SELECT * 
FROM weather 
WHERE wind_dir IS NULL;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 16. Select weather records where temperature is not missing

```{sql, output.var="sql_results"}
SELECT * 
FROM weather 
WHERE temp IS NOT NULL;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

# Aggregating Techniques

## Numerical summaries

### 17. Calculate the average temperature from the weather table as `avg_temperature`

```{sql, output.var="sql_results"}
SELECT AVG(temp) AS avg_temperature
FROM weather;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 18. Find the maximum arrival time for flights destined to ORD as `max_arr_time`

```{sql, output.var="sql_results"}
SELECT MAX(arr_time) AS max_arr_time
FROM flights
WHERE dest = 'ORD';
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

## Categorical summaries

### 19. Find the first destination alphabetically for flights from SEA as `first_sea_dest`

```{sql, output.var="sql_results"}
SELECT MIN(dest) AS first_sea_dest
FROM flights
WHERE origin = 'SEA';
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

## Rounding summaries

### 20. Round wind gust values in the weather table to 0 decimal places as `rounded_wind_gust`

```{sql, output.var="sql_results"}
SELECT ROUND(wind_gust, 0) AS rounded_wind_gust
FROM weather;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

# Sorting and Grouping Techniques

## Sorting

### 21. Sort flights by departure delay

```{sql, output.var="sql_results"}
SELECT *
FROM flights
ORDER BY dep_delay;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 22. Sort flights by descending arrival delay

```{sql, output.var="sql_results"}
SELECT *
FROM flights
ORDER BY arr_delay DESC;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

## Grouping

### 23. Sort weather data by descending visibility and then descending wind speed

```{sql, output.var="sql_results"}
SELECT *
FROM weather
ORDER BY visib DESC, wind_speed DESC;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 24. Group flights by origin and calculate the average arrival delay as `avg_arr_delay`

```{sql, output.var="sql_results"}
SELECT origin, AVG(arr_delay) AS avg_arr_delay
FROM flights
GROUP BY origin;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 25. Group flights by destination and count the number of flights for each destination having more than 100 flights as `total_flights`

```{sql, output.var="sql_results"}
SELECT dest, COUNT(*) AS total_flights
FROM flights
GROUP BY dest
HAVING COUNT(*) > 100;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

# Transforming Techniques

## Transforming

### 26. Categorize flights by distance as Short, Medium, or Long. Use 'Short' for distances less than 500 miles, 'Medium' for 500 to 2000 miles, and 'Long' for more than 2000 miles.

```{sql, output.var="sql_results"}
SELECT distance, CASE 
WHEN distance < 500 THEN 'Short'
WHEN distance BETWEEN 500 AND 2000 THEN 'Medium'
ELSE 'Long'
END AS flight_distance_category
FROM flights;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

### 27. Calculate the average speed of flights grouped by origin and destination and order by the fastest average speed

    To calculate the average speed, use the `dist` and `air_time` columns. Remember to convert `air_time` from minutes to hours for speed in miles per hour.
    
```{sql, output.var="sql_results"}
SELECT origin, dest,
AVG(distance / (air_time / 60)) AS avg_speed
FROM flights
GROUP BY origin, dest
ORDER BY avg_speed DESC;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

# Joining Techniques

## INNER JOIN

### 28. Join flights (as `f`) with weather (as `w`) on `origin` and `time_hour` (returning only the rows matching between both tables). Select the `origin`, `dest`, `temp`, and `humid` fields.

```{sql, output.var="sql_results"}
SELECT f.origin, f.dest, w.temp, w.humid
FROM flights AS f
INNER JOIN weather AS w ON f.origin = w.origin AND f.time_hour = w.time_hour;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

## LEFT JOIN

### 29. Left join flights with planes on tailnum (returning all rows from flights and only the rows from planes that match). Select the `tailnum`, `origin`, `dest`, `manufacturer`, and `model` fields.

```{sql, output.var="sql_results"}
SELECT f.tailnum, f.origin, f.dest, p.manufacturer, p.model
FROM flights AS f
LEFT JOIN planes AS p ON f.tailnum = p.tailnum;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

<!--
## RIGHT JOIN

### 32. Right join airlines (as `a`) with flights (as `f`) on carrier code (returning all rows from airlines and only the rows from flights that match). Select the `name`, `tailnum`, `origin`, and `dest` fields.

```{sql, output.var="sql_results"}
SELECT a.name, f.tailnum, f.origin, f.dest
FROM airlines AS a
RIGHT JOIN flights AS f ON a.carrier = f.carrier
ORDER BY a.name DESC;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```

-->

## Anti-Join

### 30. Anti-join flights (as `f`) with planes (as `p`) where plane's tailnum is missing. Select the `tailnum`, `origin`, and `dest` fields.

```{sql, output.var="sql_results"}
SELECT f.tailnum, f.origin, f.dest
FROM flights AS f
LEFT JOIN planes AS p ON f.tailnum = p.tailnum
WHERE p.tailnum IS NULL;
```

```{r, echo=FALSE}
if(nrow(sql_results) > 1000) {
  sql_results <- sql_results %>% sample_n(1000)
}
DT::datatable(sql_results)
```
