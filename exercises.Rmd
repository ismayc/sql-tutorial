---
title: SQL Exercises
output: learnr::tutorial
runtime: shiny_prerendered
---

<style>
.title {
  margin-bottom: 0; /* Reduces space below the title */
}
.author {
  margin-top: 0; /* Reduces space above the author */
}
</style>

<div class="title">
  <h1>SQL Exercises on Seattle and Portland Flights data</h1>
</div>
<div class="author">
  <h3>Author: Dr. Chester Ismay</h3>
</div>

```{r setup, include=FALSE}
library(learnr)
library(gradethis)
library(DBI)
library(RSQLite)
library(tidyverse)

# Copy data over into this folder
# file.copy(from = "../flights2023/pnwflights23/data/airlines.rda", 
#           to = "data/airlines.rda")
# file.copy(from = "../flights2023/pnwflights23/data/airports.rda",
#           to = "data/airports.rda")
# file.copy(from = "../flights2023/pnwflights23/data/flights.rda",
#           to = "data/flights.rda")
# file.copy(from = "../flights2023/pnwflights23/data/planes.rda",
#           to = "data/planes.rda")
# file.copy(from = "../flights2023/pnwflights23/data/weather.rda",
#           to = "data/weather.rda")

# Read data in from RDA files
load("data/airlines.rda")
load("data/airports.rda")
load("data/flights.rda")
load("data/planes.rda")
load("data/weather.rda")

## Create an ephemeral in-memory RSQLite database
con <- dbConnect(SQLite(), ":memory:")

# Write the new data to the database
dbWriteTable(con, "airlines", airlines, overwrite = TRUE)
dbWriteTable(con, "airports", airports, overwrite = TRUE)
dbWriteTable(con, "flights", flights, overwrite = TRUE)
dbWriteTable(con, "planes", planes, overwrite = TRUE)
dbWriteTable(con, "weather", weather, overwrite = TRUE)

knitr::opts_chunk$set(connection = "con", 
                      max.print = 20)
```

```{r setup2, echo=FALSE, out.width='100%', fig.align='center'}
tutorial_options(exercise.cap = "Query", 
                 exercise.eval = FALSE,
                 exercise.reveal_solution = TRUE)

library(DiagrammeR)
# https://github.com/bergant/datamodelr
library(datamodelr)

dm_f <- dm_from_data_frames(airlines, airports, flights, planes, weather)

dm_f <- dm_add_references(
  dm_f,
  
  flights$carrier == airlines$carrier,
  flights$origin == airports$faa,
  flights$dest == airports$faa,
  flights$tailnum == planes$tailnum,
  weather$origin == airports$faa
)

graph <- dm_create_graph(dm_f, rankdir = "BT", col_attr = c("column", "type"))

dm_render_graph(graph)
```

<style>
.small-yellow-btn {
padding: 5px 10px; /* Adjust padding to reduce size */
font-size: 12px; /* Smaller font size */
border-radius: 5px; /* Adjust border radius for rounded corners */
background-color: yellow; /* Set background color to yellow */
color: black; /* Text color */
border: 1px solid darkgray; /* Optional: add border */
}
</style>

<style>
.hint-container {
margin-left: 40px; /* Adjust indentation as needed */
}
</style>

# Selection Techniques

## Selecting columns/fields

1. Select all airline names from the `airlines` table.

```{r hint-server-logic, context="server", echo=FALSE}
values <- reactiveValues(hint1Visible = FALSE, hint2Visible = FALSE)

observeEvent(input$hint1, {
  values$hint1Visible <- !values$hint1Visible
})

observeEvent(input$hint2, {
  values$hint2Visible <- !values$hint2Visible
})

output$hintText1 <- renderUI({
  if(values$hint1Visible) {
    shiny::HTML("Small Hint: Start with <code>SELECT</code> followed by the column name.")
  } else {
    shiny::HTML("")  # Render empty HTML when the hint should be hidden
  }
})

output$hintText2 <- renderUI({
  if(values$hint2Visible) {
    shiny::HTML("Larger Hint: The query is <code>SELECT name FROM ___;</code> - fill in the blank.")
  } else {
    shiny::HTML("")  # Render empty HTML when the hint should be hidden
  }
})

```

```{r hint-query1, echo=FALSE}
div(class = "hint-container",
    # Hint buttons
    shiny::actionButton("hint1", "Small Hint", class = "btn small-yellow-btn"),
    shiny::actionButton("hint2", "Larger Hint", class = "btn small-yellow-btn"),
    
    # Hint output areas
    shiny::uiOutput("hintText1"),
    shiny::uiOutput("hintText2")
)
```


```{sql query1, exercise=TRUE, exercise.eval = FALSE}

```

```{sql query1-solution}
SELECT name
FROM airlines;
```

```{r query1-check, echo=FALSE}
grade_this({
  # Execute the solution query to get the correct result
  .solution <- DBI::dbGetQuery(con, .solution_code)
  
  # Execute the student's query
  .result <- DBI::dbGetQuery(con, .user_code)
  
  # Dynamically get expected columns from the solution
  cols_expected <- names(.solution)
  
  # Check for missing or extra columns
  missing_cols <- setdiff(cols_expected, names(.result))
  extra_cols <- setdiff(names(.result), cols_expected)
  
  if (length(missing_cols) > 0) {
    fail(glue::glue("Your query is missing the following columns: {toString(missing_cols)}."))
  }
  
  if (length(extra_cols) > 0) {
    fail(glue::glue("Your query should not include the following columns: {toString(extra_cols)}."))
  }
  
  # Check for matching row counts
  if (nrow(.result) != nrow(.solution)) {
    fail("The number of rows returned by your query does not match the expected result.")
  }
  
  # Check if all values in each column match, allowing for different row orders
  all_columns_match <- TRUE
  for (column in cols_expected) {
    if (!identical(sort(.result[[column]]), sort(.solution[[column]]))) {
      all_columns_match <- FALSE
      break
    }
  }
  
  if (!all_columns_match) {
    fail("The values returned by your query do not match the expected result in one or more columns.")
  }
  
  # If all checks pass
  pass("Your query appears to be correct.")
})
```

## Aliasing

## Unique entries

## View creation

## Counting

# Filtering Techniques

## Filtering rows/records

## Filtering text

# Aggregating Techniques

## Numerical summaries

## Categorical summaries

## Rounding summaries

# Sorting and Grouping Techniques

## Sorting

## Grouping

# Transforming Techniques

# Joining Techniques

## INNER JOIN

## LEFT JOIN

## RIGHT JOIN

## Anti-Join
